# Интеграция с Битрикс24

## Обзор
Приложение интегрируется в карточку сделки CRM системы Битрикс24 через iframe. При открытии страницы передаются параметры для создания смарт-процесса и обновления сделки.

## Параметры интеграции

### Входящие параметры (POST)
```php
$queryParams = http_build_query([
    'dealId' => $finalDealId,           // ID сделки
    'userId' => 'current',               // ID пользователя (всегда 'current')
    'domain' => $_REQUEST['DOMAIN'],     // Домен Битрикс24
    'authId' => $_REQUEST['AUTH_ID'],   // Токен авторизации
    'memberId' => $_REQUEST['member_id'] // ID портала
]);
```

### URL для интеграции
```
https://your-domain.com/apps/led-calculator?dealId=123&userId=current&domain=your-portal.bitrix24.ru&authId=abc123&memberId=456
```

## Настройка в Битрикс24

### 1. Создание смарт-процесса "Расчет LED экрана"

1. Перейдите в **CRM → Смарт-процессы → Типы смарт-процессов**
2. Создайте новый тип с ID `DYNAMIC_1`
3. Добавьте поля:
   - `TITLE` - Название (текст)
   - `DEAL_ID` - Привязка к сделке (привязка к сделкам)
   - `ASSIGNED_BY_ID` - Ответственный (пользователь)
   - `STAGE_ID` - Стадия (список)
   - `UF_CRM_DEAL` - Сделка (привязка к сделкам)
   - `UF_CALCULATION_DATA` - Данные расчета (текст)
   - `UF_SCREEN_TYPE` - Тип экрана (текст)
   - `UF_SCREEN_SIZE` - Размер экрана (текст)
   - `UF_TOTAL_COST` - Общая стоимость (число)
   - `UF_CURRENCY` - Валюта (список)

### 2. Настройка пользовательских полей сделки

1. Перейдите в **CRM → Настройки → Настройки полей → Сделки**
2. Добавьте поля:
   - `UF_CRM_DEAL_LED_CALCULATION` - Данные расчета LED (текст)
   - `UF_CRM_DEAL_LED_SCREEN_SIZE` - Размер LED экрана (текст)
   - `UF_CRM_DEAL_LED_TOTAL_COST` - Стоимость LED экрана (число)

### 3. Настройка прав доступа

1. Убедитесь, что пользователи имеют права на:
   - Создание смарт-процессов
   - Обновление сделок
   - Доступ к REST API

## Функциональность

### Автоматическое определение статуса
- Приложение автоматически определяет, открыто ли оно в iframe Битрикс24
- В заголовке отображается статус подключения
- Кнопка отправки активна только при наличии параметров

### Отправка данных
При нажатии кнопки "Отправить в Битрикс24":

1. **Создается смарт-процесс** с привязкой к сделке
2. **Обновляется сделка** с информацией о расчете
3. **Отображается результат** операции

### Данные для отправки
- Технические характеристики экрана
- Детальный расчет стоимости
- Информация о компонентах
- Параметры конфигурации

## Тестирование

### Локальное тестирование
```bash
# Запуск с параметрами для тестирования
http://localhost:3000/apps/led-calculator?dealId=test123&userId=current&domain=test.bitrix24.ru&authId=test&memberId=456
```

### Проверка в Битрикс24
1. Откройте приложение в iframe
2. Выполните расчет
3. Нажмите "Отправить в Битрикс24"
4. Проверьте создание смарт-процесса
5. Проверьте обновление сделки

## Обработка ошибок

### Типичные ошибки
- `Параметры Битрикс24 недоступны` - отсутствуют параметры в URL
- `Bitrix24 API error` - ошибка API (проверьте токен и права)
- `HTTP error` - проблемы с сетевым подключением

### Логирование
Все операции логируются в консоль браузера для отладки.

## Безопасность

- Токен авторизации передается через URL (стандарт Битрикс24)
- Все запросы выполняются через HTTPS
- Валидация параметров на клиенте и сервере
- Обработка ошибок API без раскрытия чувствительной информации 